{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">История розыгрышей</h1>
<div class="mb-4">
  <form action="/admin/weekly_lottery" method="get" style="display:inline-block; margin-right:5px;">
    <input type="hidden" name="period" value="past">
    <button type="submit" class="btn btn-primary">Провести лотерею за прошедшую неделю</button>
  </form>
  <form action="/admin/weekly_lottery" method="get" style="display:inline-block;">
    <input type="hidden" name="period" value="current">
    <button type="submit" class="btn btn-secondary">Провести лотерею за текущую неделю</button>
  </form>
</div>
<div class="table-responsive">
<table class="table table-striped table-bordered">
<thead>
<tr>
  <th>ID</th>
  <th>Неделя с</th>
  <th>Неделя по</th>
  <th>Проведён</th>
  <th>Победитель (User ID)</th>
  <th>Чек победителя</th>
  <th>Контакт пользователя</th>
  <th>Контакт отправлен</th>
  <th>Сумма приза</th>
  <th>Уведомление</th>
  <th>Действия</th>
</tr>
</thead>
<tbody>
{% for l in lotteries %}
<tr>
  <td>{{ l.id }}</td>
  <td>{{ l.week_start.strftime("%Y-%m-%d") }}</td>
  <td>{{ l.week_end.strftime("%Y-%m-%d") }}</td>
  <td>{{ l.conducted_at.strftime("%Y-%m-%d %H:%M") if l.conducted_at else '' }}</td>
  <td>{{ l.winner_user_id or '' }}</td>
  <td><a href="/admin/receipts/{{ l.winner_receipt_id }}">{{ l.winner_receipt_id or '' }}</a></td>
  <td>{{ l.contact_info or '-' }}</td>
  <td>{{ 'Да' if l.contact_sent else 'Нет' }}</td>
  <td>{{ l.prize_amount }}</td>
  <td>{{ 'Да' if l.notification_sent else 'Нет' }}</td>
  <td>
    {% if not l.notification_sent %}
    <form action="/admin/lotteries/{{ l.id }}/confirm" method="post" style="display:inline-block;">
      <button type="submit" class="btn btn-sm btn-success">Подтвердить</button>
    </form>
    <form action="/admin/lotteries/{{ l.id }}/reroll" method="post" style="display:inline-block; margin-left:5px;">
      <button type="submit" class="btn btn-sm btn-warning">Переиграть</button>
    </form>
    <button type="button" class="btn btn-sm btn-info" data-bs-toggle="modal" data-bs-target="#selectReceiptModal{{ l.id }}" style="margin-left:5px;">
      Выбрать номер чека
    </button>
    {% else %}
    Подтверждено
    {% endif %}
    <form action="/admin/lotteries/{{ l.id }}/delete" method="post" style="display:inline-block; margin-left:5px;">
      <button type="submit" class="btn btn-sm btn-danger">Удалить</button>
    </form>
  </td>
</tr>
{% endfor %}
</tbody>
</table>
</div>

<!-- Модальные окна для выбора чека -->
{% for l in lotteries %}
{% if not l.notification_sent %}
<div class="modal fade" id="selectReceiptModal{{ l.id }}" tabindex="-1" aria-labelledby="selectReceiptModalLabel{{ l.id }}" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="selectReceiptModalLabel{{ l.id }}">Выбрать чек для розыгрыша #{{ l.id }}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Неделя: {{ l.week_start.strftime("%d.%m.%Y") }} - {{ l.week_end.strftime("%d.%m.%Y") }}</p>
        <div id="receiptsList{{ l.id }}">
          <p>Загрузка списка чеков...</p>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}
{% endfor %}

<script>
// Функция для загрузки списка чеков
function loadReceipts(lotteryId, weekStart, weekEnd) {
  fetch(`/admin/lotteries/${lotteryId}/receipts?week_start=${weekStart}&week_end=${weekEnd}`)
    .then(response => response.json())
    .then(data => {
      const container = document.getElementById(`receiptsList${lotteryId}`);
      if (data.receipts && data.receipts.length > 0) {
        let html = '<form action="/admin/lotteries/' + lotteryId + '/set_winner" method="post">';
        html += '<div class="table-responsive"><table class="table table-sm">';
        html += '<thead><tr><th>Выбрать</th><th>ID чека</th><th>Пользователь</th><th>Сумма</th><th>Товаров Айсида</th><th>Дата</th></tr></thead><tbody>';
        
        data.receipts.forEach(receipt => {
          html += '<tr>';
          html += `<td><input type="radio" name="receipt_id" value="${receipt.id}" required></td>`;
          html += `<td>${receipt.id}</td>`;
          html += `<td>${receipt.user_id}</td>`;
          html += `<td>${receipt.amount} ₽</td>`;
          html += `<td>${receipt.items_count}</td>`;
          html += `<td>${new Date(receipt.created_at).toLocaleDateString('ru-RU')}</td>`;
          html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        html += '<div class="mt-3">';
        html += '<button type="submit" class="btn btn-primary">Установить победителя</button>';
        html += '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="margin-left: 10px;">Отмена</button>';
        html += '</div>';
        html += '</form>';
        
        container.innerHTML = html;
      } else {
        container.innerHTML = '<p class="text-muted">Нет подходящих чеков для данной недели</p>';
      }
    })
    .catch(error => {
      console.error('Ошибка загрузки чеков:', error);
      document.getElementById(`receiptsList${lotteryId}`).innerHTML = '<p class="text-danger">Ошибка загрузки списка чеков</p>';
    });
}

// Обработчик открытия модального окна
{% for l in lotteries %}
{% if not l.notification_sent %}
document.getElementById('selectReceiptModal{{ l.id }}').addEventListener('show.bs.modal', function() {
  loadReceipts({{ l.id }}, '{{ l.week_start.isoformat() }}', '{{ l.week_end.isoformat() }}');
});
{% endif %}
{% endfor %}
</script>

{% endblock %} 