{% extends "base.html" %}
{% block content %}
<h1 class="mb-4">Интеграция с Google Sheets</h1>

{% if request.query_params.get('message') %}
<div class="alert alert-info">{{ request.query_params.get('message') }}</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <form method="post" action="/admin/google_sheets">
      <div class="mb-3">
        <label for="spreadsheet_id" class="form-label">Spreadsheet ID</label>
        <input type="text" id="spreadsheet_id" name="spreadsheet_id" class="form-control" placeholder="1abc..." value="{{ spreadsheet_id or '' }}" required>
        <div class="form-text">ID таблицы из URL. Пример: https://docs.google.com/spreadsheets/d/<b>ID</b>/edit</div>
      </div>

      <div class="mb-3">
        <label for="credentials_json" class="form-label">Service Account Credentials (JSON)</label>
        <textarea id="credentials_json" name="credentials_json" class="form-control" rows="8" placeholder='{"type": "service_account", ... }' required>{{ credentials_json or '' }}</textarea>
        <div class="form-text">Вставьте содержимое JSON ключа сервисного аккаунта. Дайте доступ этой почте к таблице (Share).</div>
      </div>

      <button class="btn btn-primary" type="submit">Сохранить настройки</button>
      <a href="/admin/google_sheets/test" class="btn btn-outline-secondary ms-2">Проверить подключение</a>
      <a href="/admin/google_sheets/export_now" class="btn btn-success ms-2">Выгрузить пользователей сейчас</a>
    </form>
  </div>
  <div class="card-footer">
    <small class="text-muted">Лист для выгрузки: "Пользователи". Экспорт идёт каждые 15 минут.</small>
  </div>
</div>

<div class="card mt-4">
  <div class="card-body">
    <h5 class="card-title">Пошаговая настройка подключения</h5>
    <ol class="mb-0">
      <li><b>Включите API и создайте ключ</b>
        <ul>
          <li>Зайдите в Google Cloud Console → выберите/создайте проект.</li>
          <li>Включите <b>Google Sheets API</b> и <b>Google Drive API</b>.</li>
          <li>Создайте <b>Service Account</b> и сгенерируйте ключ: Add key → <b>Create new key</b> → <b>JSON</b>. Скачайте файл.</li>
          <li>Скопируйте e‑mail сервисного аккаунта (оканчивается на <code>iam.gserviceaccount.com</code>).</li>
        </ul>
      </li>
      <li class="mt-2"><b>Подготовьте Google‑таблицу</b>
        <ul>
          <li>Создайте пустую таблицу на Google Drive.</li>
          <li>Скопируйте <b>Spreadsheet ID</b> из URL: <code>https://docs.google.com/spreadsheets/d/ID/edit</code>.</li>
          <li>Нажмите <b>Share</b> и дайте доступ <b>Editor</b> e‑mail сервисного аккаунта.</li>
        </ul>
      </li>
      <li class="mt-2"><b>Заполните настройки на этой странице</b>
        <ul>
          <li>Вставьте <b>Spreadsheet ID</b> в соответствующее поле.</li>
          <li>Откройте скачанный JSON‑файл сервисного аккаунта и <b>целиком</b> вставьте содержимое в поле <b>Service Account Credentials (JSON)</b>.</li>
          <li>Нажмите <b>Сохранить настройки</b>.</li>
        </ul>
      </li>
      <li class="mt-2"><b>Проверьте подключение</b>
        <ul>
          <li>Нажмите <b>Проверить подключение</b>. Если всё верно — увидите подтверждение.</li>
          <li>Если ошибка 403 — проверьте, что таблица расшарена на e‑mail сервисного аккаунта с правами <b>Editor</b>.</li>
          <li>Если ошибка 404 — проверьте корректность <b>Spreadsheet ID</b>.</li>
        </ul>
      </li>
      <li class="mt-2"><b>Сделайте пробную выгрузку</b>
        <ul>
          <li>Нажмите <b>Выгрузить пользователей сейчас</b> и убедитесь, что лист «Пользователи» заполнился.</li>
          <li>Далее выгрузка будет выполняться автоматически каждые 15 минут.</li>
        </ul>
      </li>
    </ol>
  </div>
</div>

{% endblock %}


